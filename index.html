<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="BloggerCMS" />
    <meta name="description" content="Blog about all things regarding private and public clouds">
    <meta name="author" content="@20aman">

    <title>Harvesting Clouds</title>

    <!-- rss feed url -->
    <link rel="alternate" type="application/rss+xml" title="Harvesting Clouds" href="http://HarvestingClouds.com/rss.xml"/>

    <!-- favicon -->
    <link rel="shortcut icon" href="/favicon.ico"/>
    <link rel="shortcut icon" href="http://HarvestingClouds.com/favicon.ico"/>

    <!-- Bootstrap CSS file -->
    <link href="http://HarvestingClouds.com/js/plugins/bootstrap-3.0.3/css/cerulean.min.css" rel="stylesheet"/>
    <link href="http://HarvestingClouds.com/js/plugins/font-awesome-4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="http://HarvestingClouds.com/js/plugins/bootstrap-3.0.3/plugins/social-buttons.css" rel="stylesheet"/>

    <!-- syntax highlighter css file -->
    <link href="http://HarvestingClouds.com/js/plugins/highlight/styles/github.css" rel="stylesheet"/>

    <!-- lightbox for images -->
    <link href="http://HarvestingClouds.com/js/plugins/lightbox/ekko-lightbox.min.css" rel="stylesheet"/>

    <!-- blog custom CSS file -->
    <link href="http://HarvestingClouds.com/css/style.css" rel="stylesheet"/>
</head><body>
<!-- Header -->
<header class="navbar navbar-default
 navbar-fixed-top bs-docs-nav" role="banner">
    <div class="container">

        <div class="navbar-header">
            <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <a href="http://HarvestingClouds.com" class="navbar-brand">Harvesting Clouds</a>

        </div>


        <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
            <div class="navbar-form navbar-right" role="search">
                <div class="form-group">
                    <input type="text" class="searchQuery form-control" placeholder="Search Posts">
                </div>

                <button type="button" class="searchButton btn btn-default"><i class="glyphicon glyphicon-search"></i>
                    Submit
                </button>
            </div>

            <ul class="nav navbar-nav page-links">
                <li><a href="http://HarvestingClouds.com/posts.html">All Posts</a></li>
                    <li><a href="http://HarvestingClouds.com/page/about-me">About Me</a></li>
            </ul>

        </nav>
    </div>
</header>
<div class="container">
    <div class="row">
        <div class="col-md-8 main-content">
                <article>
                    <h3><a href="http://HarvestingClouds.com/post/step-by-step-arm-templates-providing-powershell-scripts-to-run-after-vm-deployment-via-arm-template">Step by Step ARM Templates - Providing PowerShell Scripts to Run after VM deployment via ARM Template</a></h3>
                    <span class="glyphicon glyphicon-user"></span> @20aman
                    &nbsp;&nbsp;
                    <span class="glyphicon glyphicon-time"></span> Oct 19, 2016
                
                        <hr>
                        <p class="post-content"><p><strong>Index</strong> of all blogs in this <strong>Step by Step ARM Templates series</strong> is located here: <a href="/post/step-by-step-azure-resource-manager-arm-templates-index/">Step by Step Azure Resource Manager (ARM) Templates - Index</a></p>
<p>By providing PowerShell Scripts to Run after VM deployment via ARM Template, you can accomplish various activities. </p>
<ul>
<li>You can setup different features and roles on the VM. </li>
<li>You can setup web server. </li>
<li>You can setup SQL Database and configure it.</li>
<li>You can configure custom policies</li>
<li>And so on...</li>
</ul>
<p>You first need to have PowerShell script files uploaded to a storage account.
To do this you add an <strong>Extension resource</strong> (<em>Microsoft.Compute/virtualMachines/extensions</em>) nested inside a VM. This extension resource should be of type &quot;<strong>CustomScriptExtension</strong>&quot;. You provide the URLs to the PowerShell scripts inside this custom script extension.</p>
<h3>Preparation</h3>
<p>As part of the preparation process you need to:</p>
<ul>
<li>Ensure that the PowerShell scripts are uploaded to the Storage Account and that you have the complete URL to the blob. </li>
<li>Or you can upload the scripts to the GitHub and get the Raw file URL</li>
<li>If there are more than one scripts then there should be one master script amongst all ps1 files which will internally invoke other files. This master file will be triggered via the template. Information of all file URLs will also be provided via the Template</li>
</ul>
<h3>Providing and configuring Scripts to Run After VM Deployment</h3>
<p>Define the below resource to provide PowerShell scripts to be run after VM deployment:</p>
<pre><code>{
   "type": "Microsoft.Compute/virtualMachines/extensions",
   "name": "MyCustomScriptExtension",
   "apiVersion": "2015-05-01-preview",
   "location": "[parameters('location')]",
   "dependsOn": [
       "[concat('Microsoft.Compute/virtualMachines/',parameters('vmName'))]"
   ],
   "properties": {
       "publisher": "Microsoft.Compute",
       "type": "CustomScriptExtension",
       "typeHandlerVersion": "1.7",
       "autoUpgradeMinorVersion":true,
       "settings": {
           "fileUris": [
           "http://Yourstorageaccount.blob.core.windows.net/customscriptfiles/start.ps1",
           "http://Yourstorageaccount.blob.core.windows.net/customscriptfiles/secondaryScript.ps1",

       ],
       "commandToExecute": "powershell.exe -ExecutionPolicy Unrestricted -File start.ps1"
     }
   }
 }</code></pre>
<p><strong>How it works:</strong></p>
<ul>
<li>Both the files i.e. start.ps1 and secondaryScript.ps1 are picked up from the storage account after VM deployment. Ensure to replace the URLs with your actual storage account blob URLs. You can add more files if needed.</li>
<li>The &quot;start.ps1&quot; is the main powerShell script which should be invoking the secondaryScript.ps1 internally</li>
<li>CommandToExecutre property is used to invoke the start.ps1 powerShell script on the deployed VM</li>
</ul>
<h3>Passing Parameters to the PowerShell Script dynamically</h3>
<p>To pass the parameters to the PowerShell script use commandToExecute property. </p>
<p>One such example to pass the parameters is shown below:</p>
<pre><code>"commandToExecute": "[concat('powershell.exe -ExecutionPolicy Unrestricted -File start.ps1', ' -domainName ', parameters('domainNameParameter')]"</code></pre>
<p>Note the use of &quot;concat&quot; helper function to create the value of the &quot;commandToExecute&quot;. Also note that there is starting and trailing space in the second argument of the concat i.e. &quot; -domainName &quot;.</p>
<p>The parameter &quot;domainNameParameter&quot; should already be defined in the template in the parameters section. If the value of parameter &quot;domainNameParameter&quot; is &quot;testdomain.com&quot; then the dynamically generated command will become:</p>
<pre><code>powershell.exe -ExecutionPolicy Unrestricted -File start.ps1 -domainName testdomain.com</code></pre>
<h3>Securing the Access to the PowerShell Script File in Storage account</h3>
<p>Let us assume you want to deploy Windows VM with Protected settings. Then use the below sample to provide the PowerShell files.</p>
<pre><code>{
    "publisher": "Microsoft.Compute",
    "type": "CustomScriptExtension",
    "typeHandlerVersion": "1.7",
    "settings": {
        "fileUris": [
            "http: //Yourstorageaccount.blob.core.windows.net/customscriptfiles/start.ps1"
        ]
    },
    "protectedSettings": {
        "commandToExecute": "powershell.exe -ExecutionPolicy Unrestricted -start.ps1",
        "storageAccountName": "yourStorageAccountName",
        "storageAccountKey": "yourStorageAccountKey"
    }
}</code></pre>
<p>Note the use of &quot;protectedSettings&quot; above. This time you also specify the Storage Account Name and the Storage Account Key.</p>
<p>You can also refer the official documentation here: <a href="https://azure.microsoft.com/en-us/documentation/articles/virtual-machines-windows-extensions-customscript/">Windows VM Custom Script extensions with Azure Resource Manager templates</a>.</p></p>
                        <br/>
                
                        <div class="post-info">
                                <span class="glyphicon glyphicon-folder-open"></span> &nbsp;
                                <a href="http://HarvestingClouds.com/category/azure">Azure</a>
                                &nbsp;&nbsp;
                
                            <span class="glyphicon glyphicon-bookmark"></span>
                
                                <a href="http://HarvestingClouds.com/tag/ARM">ARM</a>&nbsp;&nbsp;
                                <a href="http://HarvestingClouds.com/tag/Azure">Azure</a>&nbsp;&nbsp;
                                <a href="http://HarvestingClouds.com/tag/AzureResourceManager">AzureResourceManager</a>&nbsp;&nbsp;
                                <a href="http://HarvestingClouds.com/tag/PowerShell">PowerShell</a>&nbsp;&nbsp;
                                <a href="http://HarvestingClouds.com/tag/Templates">Templates</a>&nbsp;&nbsp;
                        </div>
                
                    <hr>
                </article>

            <div class="text-center clearfix">
                <div class="col-sm-4 col-md-4">
                    &nbsp;
                </div>
                <div class="col-sm-4 col-md-4">
                    <a class="btn btn-primary" href="http://HarvestingClouds.com/posts.html"><i class="fa fa-navicon"></i> View All
                        Post</a>
                </div>
                <div class="col-sm-4 col-md-4">
                    <a class="nextpost btn btn-primary"><i class="fa fa-chevron-circle-right"></i> Next Post</a>
                </div>
            </div>

        </div>

        <div class="sidebar col-md-4">
        
            <!-- Follow Panel -->
                <div class="panel panel-primary text-center">
                    <div class="panel-heading">
                        <strong>Follow Me</strong>
                    </div>
        
                    <div class="panel-body">
                        <a target="_blank" href="http://HarvestingClouds.com/rss.xml" class="btn btn-social-icon btn-outline"><i class="fa fa-rss"></i></a>
        
                            <a target="_blank" href="https://twitter.com/20aman" class="btn btn-social-icon btn-twitter"><i class="fa fa-twitter"></i></a>
                            <a target="_blank" href="https://ca.linkedin.com/in/20aman" class="btn btn-social-icon btn-linkedin"><i class="fa fa-linkedin"></i></a>
                            <a target="_blank" href="https://github.com/HarvestingClouds" class="btn btn-social-icon btn-github"><i class="fa fa-github"></i></a>
                    </div>
                </div>
        
            <!-- Custom Values from Settings page -->
        
            <!-- Latest Posts -->
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <strong>Latest Posts</strong>
                </div>
        
                <ul class="list-group">
                        <li class="list-group-item"><a href="http://HarvestingClouds.com/post/step-by-step-arm-templates-providing-powershell-scripts-to-run-after-vm-deployment-via-arm-template">Step by Step ARM Templates - Providing PowerShell Scripts to Run after VM deployment via ARM Template</a></li>
                        <li class="list-group-item"><a href="http://HarvestingClouds.com/post/step-by-step-arm-templates-using-key-vault-to-securely-provide-information-in-arm-templates">Step by Step ARM Templates - Using Key Vault to Securely Provide Information in ARM Templates</a></li>
                        <li class="list-group-item"><a href="http://HarvestingClouds.com/post/step-by-step-arm-templates-visualizing-arm-templates-and-generating-diagrams">Step by Step ARM Templates - Visualizing ARM Templates and Generating Diagrams</a></li>
                        <li class="list-group-item"><a href="http://HarvestingClouds.com/post/step-by-step-arm-templates-deploying-a-windows-vm-with-oms-integration">Step by Step ARM Templates - Deploying a Windows VM with OMS integration</a></li>
                        <li class="list-group-item"><a href="http://HarvestingClouds.com/post/azure-automation-preview-solution-start-stop-vms-during-off-hours">Azure Automation Preview Solution - Start/Stop VMs during off-hours </a></li>
                </ul>
            </div>
        
            <!-- Categories -->
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <strong>Categories</strong>
                </div>
        
                <ul class="list-group">
                        <li class="list-group-item"><a href="http://HarvestingClouds.com/category/azure">Azure</a></li>
                        <li class="list-group-item"><a href="http://HarvestingClouds.com/category/general">General</a></li>
                        <li class="list-group-item"><a href="http://HarvestingClouds.com/category/powershell">PowerShell</a></li>
                        <li class="list-group-item"><a href="http://HarvestingClouds.com/category/web-development">Web Development</a></li>
                </ul>
            </div>
        
            <!-- Archives -->
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <strong>Archives</strong>
                    </div>
        
                    <ul class="archives list-group"><li class="list-group-item archive_link"><a href="http://HarvestingClouds.com/archive/october-2016">October 2016</a></li><li class="list-group-item archive_link"><a href="http://HarvestingClouds.com/archive/september-2016">September 2016</a></li><li class="list-group-item archive_link"><a href="http://HarvestingClouds.com/archive/august-2016">August 2016</a></li><li class="list-group-item archive_link"><a href="http://HarvestingClouds.com/archive/july-2016">July 2016</a></li><li class="list-group-item archive_link"><a href="http://HarvestingClouds.com/archive/may-2016">May 2016</a></li><li class="list-group-item archive_link"><a href="http://HarvestingClouds.com/archive/april-2016">April 2016</a></li></ul>
                </div>
        
            <!-- Tags -->
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <strong>Tags Cloud</strong>
                    </div>
        
                    <div class="panel-body">
                        <ul class="list-inline">
                            <a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/net" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">net</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/activedirectory" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">activedirectory</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/ad" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">ad</a>
<a style="font-size: 13px" class="tag_cloud" href="http://HarvestingClouds.com/tag/announcement" title="3 total posts" data-original-title="4 total posts" data-toggle="tooltip">announcement</a>
<a style="font-size: 27px" class="tag_cloud" href="http://HarvestingClouds.com/tag/arm" title="20 total posts" data-original-title="21 total posts" data-toggle="tooltip">ARM</a>
<a style="font-size: 13px" class="tag_cloud" href="http://HarvestingClouds.com/tag/arm" title="3 total posts" data-original-title="4 total posts" data-toggle="tooltip">arm</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/asm" title="2 total posts" data-original-title="3 total posts" data-toggle="tooltip">asm</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/asr" title="2 total posts" data-original-title="3 total posts" data-toggle="tooltip">ASR</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/automation" title="2 total posts" data-original-title="3 total posts" data-toggle="tooltip">automation</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/automation" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">Automation</a>
<a style="font-size: 20px" class="tag_cloud" href="http://HarvestingClouds.com/tag/azure" title="11 total posts" data-original-title="12 total posts" data-toggle="tooltip">azure</a>
<a style="font-size: 30px" class="tag_cloud" href="http://HarvestingClouds.com/tag/azure" title="23 total posts" data-original-title="24 total posts" data-toggle="tooltip">Azure</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/azureautomation" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">azureautomation</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/azureresourcemanager" title="2 total posts" data-original-title="3 total posts" data-toggle="tooltip">azureresourcemanager</a>
<a style="font-size: 29px" class="tag_cloud" href="http://HarvestingClouds.com/tag/azureresourcemanager" title="22 total posts" data-original-title="23 total posts" data-toggle="tooltip">AzureResourceManager</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/azureservicemanagement" title="2 total posts" data-original-title="3 total posts" data-toggle="tooltip">azureservicemanagement</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/azuresiterecovery" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">AzureSiteRecovery</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/blob" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">blob</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/csharp" title="2 total posts" data-original-title="3 total posts" data-toggle="tooltip">csharp</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/datacenter" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">datacenter</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/dsc" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">dsc</a>
<a style="font-size: 13px" class="tag_cloud" href="http://HarvestingClouds.com/tag/general" title="3 total posts" data-original-title="4 total posts" data-toggle="tooltip">general</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/gridmvc" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">gridmvc</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/json" title="2 total posts" data-original-title="3 total posts" data-toggle="tooltip">JSON</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/keyvault" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">KeyVault</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/mvc" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">mvc</a>
<a style="font-size: 13px" class="tag_cloud" href="http://HarvestingClouds.com/tag/powershell" title="3 total posts" data-original-title="4 total posts" data-toggle="tooltip">powershell</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/powershell" title="2 total posts" data-original-title="3 total posts" data-toggle="tooltip">PowerShell</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/remoteapp" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">RemoteApp</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/runbooks" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">Runbooks</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/sample" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">Sample</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/script" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">Script</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/storage" title="2 total posts" data-original-title="3 total posts" data-toggle="tooltip">storage</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/tags" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">Tags</a>
<a style="font-size: 26px" class="tag_cloud" href="http://HarvestingClouds.com/tag/templates" title="19 total posts" data-original-title="20 total posts" data-toggle="tooltip">Templates</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/virtualmachine" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">virtualmachine</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/visualstudio" title="2 total posts" data-original-title="3 total posts" data-toggle="tooltip">VisualStudio</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/vm" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">vm</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/vmware" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">VMWare</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/webdevelopment" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">webdevelopment</a>
<a style="font-size: 12px" class="tag_cloud" href="http://HarvestingClouds.com/tag/windows" title="1 total posts" data-original-title="2 total posts" data-toggle="tooltip">windows</a>

                        </ul>
                    </div>
                </div>
            </div>
    </div>
</div>

<!-- Footer -->
<footer>
    <div class="container">
        <hr/>
        <p class="text-center">&copy; <script> document.write( new Date().getFullYear()) </script> <strong><a href="http://HarvestingClouds.com">Harvesting Clouds</a></strong></p>
    </div>
</footer>

<!-- Jquery and Bootstrap Script files -->
<script src="http://HarvestingClouds.com/js/jquery-2.0.3.min.js"></script>
<script src="http://HarvestingClouds.com/js/plugins/bootstrap-3.0.3/js/bootstrap.min.js"></script>
<script src="http://HarvestingClouds.com/js/plugins/highlight/highlight.pack.js"></script>
<script src="http://HarvestingClouds.com/js/plugins/lightbox/ekko-lightbox.min.js"></script>

<script>
    var __blogURL = 'http://HarvestingClouds.com';
</script>

<script src="http://HarvestingClouds.com/js/blog.js"></script>
<script src="http://HarvestingClouds.com/js/search.js"></script>

<!-- google analytics -->
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-75855204-1', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>
<!-- for pagination -->
<script>
    $(function () {

        ///////////////////////////////////////////////////
        // class/id/selector of prev link
        var $nextPostSelector = $('.nextpost');
        ///////////////////////////////////////////////////

        $.ajax({
            url: __blogURL + "/data/blog.json",
            type: "GET",
            dataType: "json",
            success: function (data) {
                if (data.posts !== undefined && data.posts !== null) {
                    var nextPost = data.posts[1];

                    if (nextPost === undefined || nextPost === null) {
                        // hide previous link if blog has only one post
                        $nextPostSelector.hide();
                    }
                    else {
                        $nextPostSelector.attr('href', __blogURL + '/post/' + nextPost.slug);
                    }
                }
            },
            error: function (e) {
                $nextPostSelector.hide();
            }
        });

    });
</script>